{% extends 'headbar.html' %}
{% load MyTags %}
{% load staticfiles %} {% block main_content %} {% include 'leave_message.html' %}
    <div class="container">
        <div class="row">
            <div class="col-md-12 well">
                <div class="col-md-6 col-md-offset-1">
                    <div class="row">
                        <div class="table-responsive">
                            <table class="table-condensed">
                                <tr>
                                    {% for tag in question.tags.all %}
                                        <td>
                                            <a href="{% url 'question:search' %}?searchText={{ tag.name }}">
                                                <h4><span
                                                        class="label {% cycle 'label-info'  'label-warning' 'label-primary'  'label-success' 'label-danger' %}">{{ tag.name }}
                                                </span>
                                                </h4>
                                            </a>
                                        </td>
                                    {% endfor %}
                                </tr>
                            </table>
                        </div>
                    </div>
                    <div class="row">
                        <h3>{{ question.title }}</h3>
                    </div>
                    <div class="row">
                        <p style="color: gray;">
                            {{ question.desc }}
                        </p>
                    </div>
                </div>
                <div class="col-md-4 col-md-offset-1">
                    <div class="row " style="color: #2aabd2">
                        <div class="text-center">
                            <h4><span
                                    class="glyphicon glyphicon-user"></span>&nbsp;{% if question.asker.nickname %}
                                {{ question.asker.nickname }}{% else %}{{ question.asker.username }}{% endif %}
                            </h4>
                            <h4><span
                                    class="glyphicon glyphicon-heart"></span>&nbsp;{% get_question_likes question.id %}
                            </h4>
                        </div>
                    </div>
                    <div class="row text-center">
                        <a class="btn btn-primary" href="{% url 'question:answer' question.id %}">
                        <span
                                class="glyphicon glyphicon-pencil">写回答
                        </span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-8 well">
                <div class="row">
                    <div class="list-group">
                        <a href="#" class="list-group-item ">
                            <h4 class="text-center"><span
                                    class="glyphicon glyphicon-pencil">{{ question.articles.count }}个回答</span>
                            </h4>
                        </a>
                    </div>
                </div>
                {% if question.articles.count == 0 %}
                    <div class="row">
                        <div class="text-center">
                            <a href="{% url 'question:answer' question.id %}" class="btn btn-primary"><span
                                    class="glyphicon glyphicon-pencil">我要回答</span></a>
                        </div>
                    </div>
                {% else %}
                    <div class="row">
                        {% for article in question.articles.all|dictsortreversed:'add_time' %}
                            {% with i=forloop.counter %}
                                <div class="row">
                                    <div class="col-md-2">
                                        <a href="{% url 'user:home' article.author.id %}">
                                            <img class="img-circle img-responsive img-thumbnail"
                                                 src="{{ MEDIA_URL }}{{ article.author.image }}"/>
                                        </a>
                                    </div>
                                    <div class="col-md-7">
                                        <a href="{% url 'user:home' article.author.id %}">
                                            {% if article.author.nickname %}
                                                <h4>{{ article.author.nickname }}</h4>
                                            {% else %}
                                                <h4>{{ article.author.username }}</h4>
                                            {% endif %}
                                        </a>
                                        <p style="color: gray">{{ article.author.self_description }}</p>
                                    </div>
                                    <div class="col-md-3">
                                        {% if article.author in request.user.id|my_follows %}
                                            <button name="focus" id="cancel" type="button" class="btn btn-primary"
                                                    value="{{ article.author.id }}">
                                                取消关注
                                            </button>
                                        {% else %}
                                            <button name="focus" id="ok" type="button" class="btn btn-primary"
                                                    data-placement="top" data-toggle="popover" data-trigger="focus"
                                                    data-content="不能关注自己哦！"
                                                    value="{{ article.author.id }}">
                                                关注
                                            </button>
                                        {% endif %}
                                        <button name="message" type="button" class="btn btn-primary"
                                                data-toggle="modal"
                                                data-target="#leave_message" userId="{{ article.author.id }}"
                                                who="{{ article.author.nickname }}">私信
                                        </button>
                                    </div>
                                </div>
                                <div class="row" style="margin-top: 10px">
                                    <div class="col-md-12">
                                        <div class="content">
                                            {% autoescape off %} {{ article.content }} {% endautoescape %}
                                        </div>
                                    </div>
                                </div>
                                <hr/>
                                <div class="row">
                                    <div class="col-md-1 h4">
                                        <a data-toggle="collapse" href="#collapseComment{{ i }}"><span
                                                class="glyphicon glyphicon-comment"><code>{{ article.comments.count }}</code>&nbsp;</span>
                                        </a>
                                    </div>
                                    <div class="col-md-1">
                                        <div class="praise">
                                        <span class="praiseParent"><img src="{% static 'img/zan.png' %}"
                                                                        id="praise-img"/></span>
                                            <span id="praise-txt">{{ article.up_nums }}</span>
                                            <span id="add-num"><em>+1</em></span>
                                        </div>
                                    </div>
                                    <div class="col-md-7 h4">
                                        <span class="glyphicon glyphicon-calendar"><code>{{ article.add_time|date:'M  j号 Y年' }}</code>&nbsp;</span>
                                    </div>
                                </div>
                                <hr/>
                                {% include 'comment.html' %}
                            {% endwith %}
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            <div class="col-md-4 well">
                <div class="row">
                    <div class="list-group">
                        <a class="list-group-item ">
                            <h4 class="text-center"><span class="glyphicon glyphicon-list-alt">相关问题</span>
                            </h4>
                        </a>
                    </div>
                    <div class="list-group">
                        {% for question in questions %}
                            <a href="{% url 'question:article' question.id %}" class="list-group-item"
                               style="background-color:{% cycle '#dff0d8'  '#d9edf7' '#fcf8e3'  '#f2dede' %};">
                                {{ question.title }}
                                <br>
                                <small style="color: gray">{% get_question_likes question.id %}个<span
                                        class="glyphicon glyphicon-heart"></span></small>
                            </a>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {#    <script>#}
    {#        $(function () {#}
    {#            $(".praiseParent").click(function () {#}
    {#                var currrent = $(this);#}
    {#                var praise_img = currrent.children();#}
    {#                var praise_txt = currrent.next();#}
    {#                var text_box = currrent.siblings().eq(1)#}
    {#                //var praise_img = $("#praise-img");#}
    {#                //var praise_txt = $("#praise-txt");#}
    {#                //var text_box = $("#add-num");#}
    {#                var num = parseInt(praise_txt.text());#}
    {#                if (praise_img.attr("src") == ("{% static 'img/yizan.png' %}")) {#}
    {#                    $(this).html("<img src='{% static 'img/zan.png' %}' id='praise-img' class='animation' />");#}
    {#                    praise_txt.removeClass("hover");#}
    {#                    text_box.show().html("<em class='add-animation'>-1</em>");#}
    {#                    $(".add-animation").removeClass("hover");#}
    {#                    num -= 1;#}
    {#                    praise_txt.text(num)#}
    {#                } else {#}
    {#                    $(this).html("<img src='{% static 'img/yizan.png' %}' id='praise-img' class='animation' />");#}
    {#                    praise_txt.addClass("hover");#}
    {#                    text_box.show().html("<em class='add-animation'>+1</em>");#}
    {#                    $(".add-animation").addClass("hover");#}
    {#                    num += 1;#}
    {#                    praise_txt.text(num)#}
    {#                }#}
    {#            });#}
    {#        })#}
    {##}
    {#    </script>#}
    {##}
    {##}
    <script>
        $(document).ready(function () {
            $('button[name="focus"]').click(function () {
                var focusObject = $(this);
                $.ajax({
                    url: '{% url "user:follow" %}',
                    type: 'get',
                    dataType: 'text',
                    data: {
                        'follower_id': {{ request.user.id|default:'-1' }},
                        'followee_id': focusObject.val(),
                        'follow_tip': focusObject.attr('id')
                    },
                    success: function (data) {
                        if (data === 'canceled') {
                            focusObject.html('关注');
                            focusObject.attr('id', 'ok')
                        }
                        else if (data === 'focused') {
                            focusObject.html("取消关注");
                            focusObject.attr('id', 'cancel')
                        }
                        else if (data === 'redirect') {
                            $(window).attr('location', '{% url 'user:login_reg' %}');
                        }
                        else if (data === 'self') {
                            $('[data-toggle="popover"]').popover();
                        }
                    },
                    error: function () {
                        alert('出现错误!');
                    }
                });
            });
        });


    </script>


    {#        $(document).ready(function () {#}
    {#            $('button[name="submitComment"]').click(function () {#}
    {#                var buttonObj = $(this);#}
    {#                var value = buttonObj.val()#}
    {#                var inputText = '#' + value#}
    {#                var inputName = $(inputText).attr('name')#}
    {#                var id_list_group = '#list_group' + inputName#}
    {#                //alert(id_list_group);#}
    {#                $.ajax({#}
    {#                    url: '{% url 'article' %}',#}
    {#                    type: 'get',#}
    {#                    dataType: 'text',#}
    {#                    data: {#}
    {#                        'user_id': {{ client.id }},#}
    {#                        'comment_text': $(inputText).val(),#}
    {#                        'article_id': inputName#}
    {#                    },#}
    {#                    success: function (data) {#}
    {#                        if (data == 'ok') {#}
    {#                            var string = '<a class="list-group-item "><div class="row"><div class="col-md-2"><img src="/uploads/default/zhi.jpg" width="80" class="img-responsive img-thumbnail"/></div><div class="col-md-7"><h4>{{ client.nickname }}</h4><p style="color: gray;">{{ client.self_description }}</p></div><div class="col-md-3"><p>刚刚发表</p></div></div><div class="row"><div class="col-md-10 col-md-offset-1"><h4 id="list_group_item_text">' + $(inputText).val() + '</h4></div></div><div class="row"><div class="col-md-offset-1"><span class="glyphicon glyphicon-thumbs-up"><code>0</code>&nbsp;</span></div></div></a>'#}
    {#                            $(id_list_group).append(string)#}
    {#                        }#}
    {#                    },#}
    {#                    error: function () {#}
    {#                        alert('出现错误!');#}
    {#                    }#}
    {#                });#}
    {#            });#}
    {#        });#}
    {##}
    {#        $(document).ready(function () {#}
    {#            $('button[name="message"]').click(function () {#}
    {#                var messageObject = $(this);#}
    {#                var userId = messageObject.attr('userId');#}
    {#                var who = messageObject.attr('who');#}
    {#                $('#messsage_to').html('私信给: ' + who)#}
    {#                $('#leave_message').modal();#}
    {#                $('#sendTo').click(function () {#}
    {#                    //alert(userId+$('#message_text').val()+{{ client.id }});#}
    {##}
    {#                    $.ajax({#}
    {#                        url: "{% url 'article' %}",#}
    {#                        type: 'get',#}
    {#                        dataType: 'text',#}
    {#                        data: {#}
    {#                            'from_user_id': {{ client.id }},#}
    {#                            'message_text': $('#message_text').val(),#}
    {#                            'to_user_id': userId#}
    {#                        },#}
    {#                        success: function (data) {#}
    {#                            if (data == 'ok') {#}
    {#                                var string = '<p class="text-center text-primary" ><strong>发送成功</strong></p>';#}
    {#                                setTimeout(function () {#}
    {#                                    test();#}
    {#                                }, 10000);#}
    {#                                $('#privateMessageBody').append(string).delay('slow').fadeIn();#}
    {##}
    {#                                setTimeout(function () {#}
    {#                                    test();#}
    {#                                }, 100000);#}
    {#                                $('#leave_message').modal('hide')#}
    {#                            }#}
    {#                        },#}
    {#                        error: function () {#}
    {#                            alert('出现错误!');#}
    {#                        }#}
    {#                    });#}
    {#                });#}
    {##}
    {#            });#}
    {#        });#}
    {##}
    {#    </script>#}
{% endblock %}